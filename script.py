import requests
import sys
import json


def user_prompt(cves):
    while True:
        print("\nDo you want to select specific CVEs or use all of them?")
        print("1) Select specific CVEs.")
        print("2) Use all.")

        option = input("\nChoose an option (1 or 2): ")

        if option == '1':
            return select_cves(cves)
        elif option == '2':
            return cves
        else:
            print("\nInvalid response. Please choose either 1 or 2.")


def select_cves(cves):
    chosen_cves = []

    for i, cve in enumerate(cves, 1):
        print(f"{i}) {cve}")

    while True:
        selection = input(
            "\nSelect a CVE from the list above (or type 'done' when finished): ")

        if selection.lower() == 'done':
            break
        elif selection.isdigit() and int(selection) <= len(cves):
            chosen_cves.append(cves[int(selection) - 1])
        else:
            print(
                "\nInvalid response. Please select a number from the list, or type 'done'.")

    return chosen_cves


entity_id = sys.argv[1] if len(sys.argv) > 1 else None

if not entity_id:
    print("Please provide an EntityId as an argument when running this script.")
    sys.exit()

# Replace : with %3A in the EntityId
entity_id = entity_id.replace(":", "%3A")

url = f"https://api.eu1.dome9.com/v2/vulnerability/scan-results?EntityType=Image&EntityId={entity_id}"
headers = {
    "accept": "application/json",
    "authorization": "Basic YjA1NGE5NWUtZDhlNy00ZmNlLWJmMDctMWFhMjI3NmI4Zjc5Omkxc2R5dHhkb2lveW44b2hiODd1Z2tmbg=="
}

response = requests.get(url, headers=headers)
data = response.json()

# Extract only CVEs
cve_list = []
for package in data['vulnerablePackages']:
    for cve in package['cves']:
        cve_list.append(cve['cveId'])

chosen_cves = user_prompt(cve_list)
for cve in chosen_cves:
    print(cve)
